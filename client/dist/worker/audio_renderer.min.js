var sine_lookup_size=8192,sine_lookup_size_m1=sine_lookup_size-1,sine_lookup=new Float32Array(sine_lookup_size),sine_lookup_phase=0,sine_lookup_phase_step=2*Math.PI/sine_lookup_size,s=0,oscillators=[];for(s=0;s<sine_lookup_size;s+=1)sine_lookup[s]=Math.sin(sine_lookup_phase),sine_lookup_phase+=sine_lookup_phase_step;self.onmessage=function(s){"use strict";var e,o,a,i=s.data,t=i.sample_rate,p=i.data,_=i.data[0],n=1/(i.options.sps?i.options.sps:60),l=Math.round(n*t),r=p.length*l,h=(p.length,null),u=null,f=0,k=0,d=0,g=0,M=0,c=0,z=0,b=0,m=1/l,v=0,y=null,x=16.34,F=0,w=0,A=0;z=0;for(o=i.options.octaves?i.height/i.options.octaves:i.height/10,i.options.baseFrequency&&(x=i.options.baseFrequency),w=0;w<i.height;w+=1)a=x*Math.pow(2,w/o)/t*sine_lookup_size,oscillators[i.height-1-w]={phase_step:a,phase_index:Math.random()*sine_lookup_size_m1};for(h=new Float32Array(r),u=new Float32Array(r),b=0;b<r;b+=1){for(f=0,k=0,w=0;w<_.length;w+=1)e=_[w],y=oscillators[e.y],A=sine_lookup[y.phase_index&sine_lookup_size_m1],f+=(e.pl+e.dl*F)*A,k+=(e.pr+e.dr*F)*A,y.phase_index+=y.phase_step;h[b]=f,u[b]=k,d+=Math.abs(f),g+=Math.abs(k),M=Math.max(f,M),c=Math.max(k,c),F+=m,(v+=1)>=l&&(F=0,v=0,z+=1,_=i.data[z])}var q=1-M,I=1-c;for(b=0;b<r;b+=1)h[b]/=q,u[b]/=I;var P=0;if(r>32)for(b=0;b<8;b+=1)h[b]*=P,u[b]*=P,h[r-b-1]*=P,u[r-b-1]*=P,P+=1/8;d/=r,g/=r,postMessage({uid:i.uid,length:r,data_l:h.buffer,data_r:u.buffer,avg_l:d,avg_r:g,opts:i.options},[h.buffer,u.buffer])};